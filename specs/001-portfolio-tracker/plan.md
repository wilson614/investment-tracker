# Implementation Plan: Family Investment Portfolio Tracker

**Branch**: `001-portfolio-tracker` | **Date**: 2026-01-09 | **Spec**: `/specs/001-portfolio-tracker/spec.md`
**Input**: Feature specification from `/specs/001-portfolio-tracker/spec.md`

## Summary

A self-hosted web application for family members to track investment portfolios with real-time quotes, XIRR calculations, multi-currency support, and year-end valuation using historical prices. Key features include:
- Multi-user authentication with JWT
- Portfolio and transaction management
- Real-time stock quotes from Sina Finance and TWSE
- Currency ledger with weighted average cost tracking
- Historical price caching for year-end valuations
- Market YTD comparison with benchmark ETFs
- CSV export for transactions and positions

## Technical Context

**Language/Version**: C# .NET 8 (Backend), TypeScript 5.x with React (Frontend)
**Primary Dependencies**: ASP.NET Core 8, Entity Framework Core, React 18, Vite, TanStack Query
**Storage**: SQLite (development), PostgreSQL (production-compatible)
**Testing**: xUnit (backend), Jest/React Testing Library (frontend)
**Target Platform**: Docker containers for self-hosted deployment
**Project Type**: Web application (backend API + frontend SPA)
**Performance Goals**: <200ms API response time, <512MB RAM idle
**Constraints**: Must work offline after deployment, no external cloud dependencies for core features
**Scale/Scope**: Multi-user family use (5-10 users), single instance deployment

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Clean Architecture | ✅ Pass | Domain/Infrastructure/API layers separated |
| II. Multi-Tenancy | ✅ Pass | User-based data isolation with JWT auth |
| III. Accuracy First | ✅ Pass | decimal types for money, XIRR with proven methods |
| IV. Self-Hosted Friendly | ✅ Pass | Docker deployment, SQLite/PostgreSQL support |
| V. Technology Stack | ✅ Pass | .NET 8 + React as specified |

## Project Structure

### Documentation (this feature)

```text
specs/001-portfolio-tracker/
├── plan.md              # This file
├── research.md          # Technical decisions and API research
├── data-model.md        # Entity definitions and DTOs
├── spec.md              # Feature specification
├── contracts/           # API contracts
│   └── openapi.yaml     # OpenAPI 3.0 specification
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── InvestmentTracker.Api/           # ASP.NET Core Web API
│   │   ├── Controllers/                 # API endpoints
│   │   ├── Middleware/                  # Auth, error handling
│   │   └── Program.cs                   # Host configuration
│   ├── InvestmentTracker.Domain/        # Business logic
│   │   ├── Entities/                    # Domain entities
│   │   ├── Enums/                       # Enumerations
│   │   ├── Services/                    # Domain services
│   │   └── Interfaces/                  # Abstractions
│   └── InvestmentTracker.Infrastructure/# Data access, external APIs
│       ├── Data/                        # EF Core DbContext
│       ├── Repositories/                # Data access
│       └── ExternalApis/                # Sina, TWSE clients
└── tests/
    ├── InvestmentTracker.Domain.Tests/  # Unit tests
    └── InvestmentTracker.Api.Tests/     # Integration tests

frontend/
├── src/
│   ├── components/                      # Reusable UI components
│   ├── pages/                           # Route pages
│   ├── services/                        # API clients, utilities
│   ├── hooks/                           # Custom React hooks
│   ├── stores/                          # State management
│   └── types/                           # TypeScript types
└── tests/                               # Jest tests
```

**Structure Decision**: Web application with separate backend (ASP.NET Core API) and frontend (React SPA) projects.

## Key Implementation Areas

### 1. Page Refresh Behavior (FR-040)
- Auto-trigger quote fetch on page load/refresh
- Show loading state on "更新報價" button during fetch
- Display cached values immediately, update after fetch completes

### 2. CSV Export (FR-041)
- Frontend-only implementation using Blob API
- UTF-8 with BOM for Excel compatibility
- Export transactions and positions

### 3. Market YTD Comparison (FR-042)
- Backend service to fetch benchmark ETF prices
- Store Jan 1 prices in HistoricalPrice table (BENCHMARK: prefix)
- Compare portfolio YTD vs market benchmarks

### 4. Taiwan Stock Support (FR-043)
- Handle TWD-TWD transactions (exchange rate = 1.0)
- Proper formatting for Taiwan market prices

## Complexity Tracking

No constitution violations requiring justification.
