# Implementation Plan: Closed-Loop Performance Model & Transaction Type Redesign

**Branch**: `011-closed-loop-performance-model` | **Date**: 2026-02-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-closed-loop-performance-model/spec.md`

## Summary

Redesign currency transaction semantics and API enum names, enforce backend-first validation with matching CSV all-or-nothing validation/diagnostics, and correct annual performance to a strict closed-loop model (`V_t = stock market value + bound ledger balance`, including negative ledger). The implementation will align Modified Dietz and TWR to the same valuation baseline and explicit external cash-flow set, and update all related UI/help text/import-export labels.

## Technical Context

**Language/Version**: C# .NET 8 (backend), TypeScript 5.x + React 18 (frontend)
**Primary Dependencies**: ASP.NET Core 8, Entity Framework Core, FluentValidation, Vite, Vitest, React Testing Library
**Storage**: PostgreSQL
**Testing**: xUnit (backend), Vitest + React Testing Library (frontend)
**Target Platform**: Web app on Linux containers (self-hosted)
**Project Type**: Web application (frontend + backend)
**Performance Goals**: Maintain current annual-performance API responsiveness while adding closed-loop baseline consistency and strict import diagnostics
**Constraints**:
- No backward compatibility aliases for deprecated enum names (FR-008)
- CSV import must be all-or-nothing with full error set in one response (FR-007/007b)
- Negative ledger balances must never be floored in valuation path (FR-010)
- Modified Dietz and TWR must use same closed-loop baseline and explicit external CF policy (FR-011/FR-012)
**Scale/Scope**:
- Multi-layer change across backend domain/application/api + frontend forms/import/export/performance copy
- Update of existing automated tests and addition of focused regression coverage for validation and performance correctness

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle / Standard | Status | Notes |
|---|---|---|
| I. Clean Architecture | PASS | Changes remain within Domain/Application/API boundaries; no layer inversion required |
| II. Multi-Tenancy | PASS | Existing user-ownership checks in use cases/controllers remain required and unchanged in principle |
| III. Accuracy First | PASS | This feature strengthens valuation/CF correctness and preserves decimal-based financial computation |
| IV. Self-Hosted Friendly | PASS | No mandatory new external service/dependency for core functionality |
| V. Technology Stack | PASS | Stays within .NET 8 + React + PostgreSQL stack |
| Database Standards | PASS | No mandatory schema redesign identified in planning artifacts |
| API Standards | PASS | New/updated contracts keep REST + consistent error structures |
| Security Requirements | PASS | Validation remains at API boundary + use case checks; no secret handling changes |
| Quality Standards | PASS | Plan includes targeted regression tests for financial and validation paths |

**Post-Design Re-check**: PASS. No constitution violations introduced by research/design outputs.

## Project Structure

### Documentation (this feature)

```text
specs/011-closed-loop-performance-model/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── api-contracts.md
└── tasks.md               # generated by /speckit.tasks
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── InvestmentTracker.Domain/
│   │   ├── Enums/
│   │   │   └── CurrencyTransactionType.cs
│   │   ├── Entities/
│   │   │   └── CurrencyTransaction.cs
│   │   └── Services/
│   │       └── ReturnCashFlowStrategy.cs
│   ├── InvestmentTracker.Application/
│   │   ├── DTOs/
│   │   │   └── CurrencyLedgerDtos.cs
│   │   ├── Services/
│   │   │   └── HistoricalPerformanceService.cs
│   │   ├── UseCases/
│   │   │   ├── CurrencyTransactions/
│   │   │   │   ├── CreateCurrencyTransactionUseCase.cs
│   │   │   │   └── UpdateCurrencyTransactionUseCase.cs
│   │   │   └── StockTransactions/
│   │   │       └── StockTransactionLinking.cs
│   │   └── Validators/
│   │       ├── CreateCurrencyTransactionRequestValidator.cs
│   │       └── UpdateCurrencyTransactionRequestValidator.cs
│   ├── InvestmentTracker.API/
│   │   └── Controllers/
│   │       └── CurrencyTransactionsController.cs
│   └── InvestmentTracker.Infrastructure/
│       └── Services/
│           └── TransactionPortfolioSnapshotService.cs
└── tests/
    ├── InvestmentTracker.Application.Tests/
    ├── InvestmentTracker.Domain.Tests/
    └── InvestmentTracker.API.Tests/

frontend/
├── src/
│   ├── components/
│   │   ├── currency/
│   │   │   └── CurrencyTransactionForm.tsx
│   │   ├── import/
│   │   │   └── CurrencyImportButton.tsx
│   │   └── transactions/
│   │       └── TransactionForm.tsx
│   ├── pages/
│   │   ├── CurrencyDetail.tsx
│   │   └── Performance.tsx
│   ├── services/
│   │   └── csvExport.ts
│   └── types/
│       └── index.ts
└── src/test/
    └── performance.metrics-binding.test.tsx
```

**Structure Decision**: Use existing web-app monorepo structure; apply minimal-scope edits in current backend/frontend modules without introducing new architecture layers.

## Complexity Tracking

No constitution gate violations requiring exception handling.
