# =============================================================================
# Production Docker Compose - 使用預建 images + Webhook 自動部署
# =============================================================================
# 使用方式:
#   1. 複製 .env.example 為 .env 並填入設定
#   2. docker compose -f docker-compose.prod.yml up -d
# =============================================================================

services:
  postgres:
    image: postgres:16-alpine
    container_name: investmenttracker-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-investmenttracker}
      POSTGRES_USER: ${DB_USER:-investmenttracker}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-investmenttracker} -d ${DB_NAME:-investmenttracker}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - default # 資料庫只需要讓後端連得到，不需要給 Tunnel

  backend:
    # 這裡不用改字，但前提是你上一各步驟的 GitHub Action 必須跑成功
    # 這樣 ghcr.io 裡面才會有 ARM64 的版本給這台機器拉
    image: ghcr.io/${GITHUB_REPO}/backend:latest
    container_name: investmenttracker-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:5000
      # 注意：這裡的 host 是 container_name
      ConnectionStrings__DefaultConnection: Host=investmenttracker-db;Database=${DB_NAME:-investmenttracker};Username=${DB_USER:-investmenttracker};Password=${DB_PASSWORD}
      Jwt__Secret: ${JWT_SECRET:?JWT_SECRET is required}
      Jwt__Issuer: InvestmentTracker
      Jwt__Audience: InvestmentTracker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - default
      # 如果前端是透過瀏覽器直接打 API (Client-side rendering)，
      # 後端也需要加入 tunnel-net 才能被 Cloudflare 轉發
      # 如果你是 Server-Side Rendering (Next.js 等) 則看架構
      # 保險起見，若 API 需要對外開放，請加：
      - tunnel-net 

  frontend:
    image: ghcr.io/${GITHUB_REPO}/frontend:latest
    container_name: investmenttracker-web
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - default
      - tunnel-net

  webhook:
    # [修改重點] 換成這個支援 ARM64 的官方映像檔
    image: adnanh/webhook:latest
    container_name: investmenttracker-webhook
    restart: unless-stopped
    # 這裡的 command 參數跟 almir 版是相容的，不用動
    command: ["-verbose", "-hooks=/etc/webhook/hooks.json", "-hotreload"]
    environment:
      DEPLOY_TOKEN: ${DEPLOY_WEBHOOK_SECRET:?DEPLOY_WEBHOOK_SECRET is required}
    volumes:
      - ./webhook-hooks.json:/etc/webhook/hooks.json:ro
      - ./deploy.sh:/scripts/deploy.sh:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - tunnel-net

volumes:
  pgdata:

networks:
  default:
    driver: bridge
  tunnel-net:
    external: true
